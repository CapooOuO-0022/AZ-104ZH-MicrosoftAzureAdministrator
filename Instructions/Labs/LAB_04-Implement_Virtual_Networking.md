---
lab:
    title: '04 - 实现虚拟网络'
    module: '模块 04 – 虚拟网络'
---

# 实验室 04 - 实现虚拟网络

# 学生实验室手册

## 实验室场景

你需要探索 Azure 虚拟网络功能。首先，你计划在 Azure 中创建一个虚拟网络，该网络将托管几台 Azure 虚拟机。由于你打算实现基于网络的分段，因此你会将它们部署到虚拟网络的不同子网中。你还希望确保他们的专用 IP 地址和公共 IP 地址不会随时间变化而变化。为了符合 Contoso 的安全要求，你需要保护可从网络访问的 Azure 虚拟机的公共终结点。最后，你需要为虚拟网络和互联网的 Azure 虚拟机实施 DNS 名称解析。

## 目标

在本实验室中，你将：

+ 任务 1：创建和配置虚拟网络
+ 任务 2：将虚拟机部署到虚拟网络中
+ 任务 3：配置 Azure VM 的专用和公共 IP 地址
+ 任务 4：配置网络安全组
+ 任务 5：配置 Azure DNS 以进行内部名称解析
+ 任务 6：配置 Azure DNS 以进行外部名称解析

## 说明

### 练习 1：

#### 任务 1：创建和配置虚拟网络

在该任务中，你将使用 Azure 门户创建一个新的拥有多个子网的虚拟网络

1. 登录到 [Azure 门户](https://portal.azure.com)。

1. 在 Azure 门户中，搜索并选择 **“虚拟网络”**，并在 **“虚拟网络”** 边栏选项卡中单击 **“+ 添加”**。

1. 创建一个虚拟网络，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你将在本实验室中使用的 Azure 订阅名 |
    | 资源组 | 一个新资源组的名称 **az104-04-rg1** |
    | 名称 | **az104-04-vnet1** |
    | 区域 | 你将在本实验室中使用的订阅中可用的任何 Azure 区域的名称 |
    | IPv4 地址空间 | **10.40.0.0/20** |
    | 子网名 | **subnet0** |
    | 子网地址范围 | **10.40.0.0/24** |

    >**注意：**等待预配虚拟网络。用时应该少于一分钟。

1. 在 **“虚拟网络”** 边栏选项卡中，单击 **“刷新”**，然后单击 **“az104-04-vnet1”**。

1. 在 **“az104-04-vnet1”** 虚拟网络边栏选项卡中，单击 **“子网”**，然后单击 **“+ 子网”**。 

1. 创建一个子网，设置如下（其他则保留其默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **subnet1** |
    | 地址范围（CIDR 块） | **10.40.1.0/24** |
    | 网络安全组 | **无** |
    | 路由表 | **无** |

#### 任务 2：将虚拟机部署到虚拟网络中

在此任务中，你可使用 ARM 模板将 Azure 虚拟机部署到虚拟网络的不同子网中。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

    >**说明**：如果这是你第一次启动 **“Cloud Shell”**，并看到 **“你没有装载存储”** 的消息，请选择你在本实验中使用的订阅，然后单击 **“创建存储”**。 

1. 在 Cloud Shell 窗格的工具栏中，单击 **“上传/下载文件”** 图标，在下拉菜单中单击 **“上传”** 并上传文件 **\\Allfiles\\Labs\\04\\az104-04-vms-template.json** 和 **\\Allfiles\\Labs\\04\\az104-04-vms-parameters.json** 到 Cloud Shell 主目录。

    >**说明**：你可能需要分别上传各个文件。

1. 在 Cloud Shell 窗格中，使用你上传的模板和参数文件运行以下命令来部署两台虚拟机：

   ```pwsh
   $rgName = 'az104-04-rg1'

   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-04-vms-template.json `
      -TemplateParameterFile $HOME/az104-04-vms-parameters.json
   ```

    >**注意**：这种部署 ARM 模板的方法需使用 Azure PowerShell。你可以通过运行等效的 Azure CLI 命令 **az deployment create** 来执行同样的任务（有关更多信息，请参阅[使用资源管理器模板和 Azure CLI 部署资源](https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/templates/deploy-cli)。

    >**说明**：等待部署完成，再继续执行下一个任务。该操作需约 2 分钟。

1. 关闭 Cloud Shell 窗格。

#### 任务 3：配置 Azure VM 的专用和公共 IP 地址

在此任务中，你将配置分配到 Azure 虚拟机网络接口的公共和专用 IP 地址的静态分配。

   >**说明**：专用和公共 IP 地址实际上分配到网络接口，而这些接口又附加在 Azure 虚拟机上，但是，改为引用分配给 Azure VM 的 IP 地址相当普遍。

1. 在 Azure 门户中，搜索并选择 **“资源组”**，并在 **“资源组”** 边栏选项卡中单击 **“az104-04-rg1”**。

1. 在 **“az104-04-rg1”** 资源组边栏选项卡的资源列表中，单击 **“az104-04-vnet1”**。

1. 在 **“az104-04-vnet1”** 虚拟网络边栏选项卡中，查看 **“已连接设备”** 部分，并验证是否有两个网络接口 **az104-04-nic0** 和 **az104-04-nic1** 连接到虚拟网络。

1. 单击 **az104-04-nic0** 并且在 **az104-04-nic0** 边栏选项卡中，单击 **“IP 配置”**。 

    >**说明**：验证 **ipconfig1** 当前是否采用动态专用 IP 地址进行设置。

1. 在 IP 配置列表中，单击 **“ipconfig1”**。

1. 在 **“ipconfig1”** 边栏选项卡中，把 **“分配”** 设为 **“静态”**，把 **“IP 地址”** 的默认值设为 **“10.40.0.4”**。

1. 在 **“ipconfig1”** 边栏选项卡中，将 **“公共 IP 地址”** 设置为 **“已启用”**， 然后单击 **“IP 地址 - 配置所需的设置”**。 

1. 在 **“选择公共 IP 地址”** 边栏选项卡，单击 **“+ 新建”** 并创建一个新的公共 IP 地址，设置如下：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-04-pip0** |
    | SKU | **标准** |

1. 返回 **“ipconfig1”** 边栏选项卡，保存更改。

1. 导航回到 **“az104-04-vnet1”** 边栏选项卡，并重复前面的六个步骤，将 **“az104-04-nic1”** 的 **“ipconfig1”** 的 IP 地址分配更改为 **“静态”**，并将 **“az104-04-nic1”** 和名为 **“az104-04-pip1”** 的新标准 SKU 公共 IP 地址关联起来。

1. 导航回 **“az104-04-rg1”** 资源组边栏选项卡，在资源列表中单击 **“az104-04-vm0”**，并记下 **“az104-04-vm0”** 虚拟机边栏选项卡中的公共 IP 地址条目。

1. 返回 **“az104-04-rg1”** 资源组边栏选项卡，在其资源列表中，单击 **“az104-04-vm1”**，并记下 **“az104-04-vm1”** 虚拟机边栏选项卡的公共 IP 地址条目。

    >**说明**：在本实验室的最后一个任务中，你将需要这两个 IP 地址。 


#### 任务 4：配置网络安全组

在此任务中，你将配置网络安全组，以允许对 Azure 虚拟机的受限连接。

1. 在 Azure 门户中，返回 **“az104-04-rg1”** 资源组边栏选项卡，然后在其资源列表中单击 **“az104-04-vm0”**。

1. 在 **“az104-04-vm0”** 边栏选项卡中，单击 **“连接”**，在下拉菜单中，单击 **“RDP”**，在 **“与 RDP 连接”** 边栏选项卡中，单击 **“下载 RDP 文件”**，并按照提示启动远程桌面会话。

1. 请注意，连接尝试失败。

    >**说明**：这很正常，因为在默认情况下，标准 SKU 的公共 IP 地址会要求其分配到的网络接口接受网络安全组的保护。为了允许远程桌面连接，你将创建一个网络安全组，明确允许来自 Internet 的入站 RDP 流量，并将这些流量分配到两台虚拟机的网络接口。

1. 在 Azure 门户中，搜索并选择 **“网络安全组”**，并在 **“网络安全组”** 边栏选项卡中单击 **“+ 添加”**。

1. 创建一个网络安全组，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-04-rg1** |
    | 名称 | **az104-04-nsg01** |
    | 区域 | 你在本实验室中部署的所有其他资源的 Azure 区域的名称 |

    >**说明**：等待部署完成。该操作需约 2 分钟。

1. 在“部署”边栏选项卡上，单击 **“前往资源”**以打开 **“az104-04-nsg01”** 网络安全组边栏选项卡。 

1. 在 **“az104-04-nsg01”** 网络安全组边栏选项卡中的 **“设置”** 部分，单击 **“入站安全规则”**。 

1. 添加一个入站规则，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 源 | **任何** |
    | 源端口范围 | * |
    | 目标 | **任何** |
    | 目标端口范围 | **3389** |
    | 协议 | **TCP** |
    | 操作 | **允许** |
    | 优先级 | **300** |
    | 名称 | **AllowRDPInBound** |

1. 在 **“az104-04-nsg01”** 网络安全组边栏选项卡的 **“设置”** 部分，单击 **“网络接口”**，然后单击 **“+ 关联”**。

1. 把 **az104-04-nsg01** 网络安全组与 **az104-04-nic0** 和 **az104-04-nic1** 网络接口关联起来。

    >**说明**：新创建的网络安全组中的规则可能需要 5 分钟才能应用到网络接口卡。

1. 返回 **az104-04-vm0** 虚拟机边栏选项卡。

    >**说明**：现在，验证你是否可以成功登录到目标虚拟机并使用 **Student** 用户名和 **Pa55w.rd1234** 密码。

1. 在 **“az104-04-vm0”** 边栏选项卡中，单击 **“连接”**，在下拉菜单中，单击 **“RDP”**，在 **“连接到 RDP”** 边栏选项卡中，单击 **“下载 RDP 文件”**，并按照提示启动远程桌面会话。

    >**说明**：此步骤参阅通过远程桌面与 Windows 计算机进行连接。在 Mac 上，你可以从 Mac 应用商店下载远程桌面客户端；而在 Linux 计算机上，你可以使用开放源代码 RDP 客户端软件。

    >**说明**：当连接到目标虚拟机时，你可以忽略任何警告提示。

1. 当出现提示时，请使用用户名 **Student** 和密码 **Pa55w.rd1234** 登录。

    >**说明**：保持远程桌面会话开启。你将在下一个任务中用到它。

#### 任务 5：配置 Azure DNS 以进行内部名称解析

在此任务中，你将使用 Azure 专用 DNS 区域在虚拟网络中配置 DNS 名称解析。

1. 在 Azure 门户中，搜索并选择 **“专用 DNS 区域”**，并在 **“专用 DNS 区域”** 边栏选项卡中，单击 **“+ 添加”**。

1. 创建一个专用 DNS 区域，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-04-rg1** |
    | 名称 | **contoso.org** |

    >**说明**：等待专用 DNS 区域创建完毕。该操作需约 2 分钟。

1. 单击 **“前往资源”** 以打开 **“contoso.org”** DNS 专用区域边栏选项卡。 

1. 在 **“contoso.org”** 专用 DNS 区域边栏选项卡中，在 **“设置”** 部分，单击 **“虚拟网络链接”**

1. 添加一个虚拟网络链接，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 链接名称 | **az104-04-vnet1-link** |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 虚拟网络 | **az104-04-vnet1** |
    | 启用自动注册 | 已启用 |

    >**注意：**等待虚拟网络链接创建完成。这应该需要不到一分钟。

1. 在 **“contoso.org”** 专用 DNS 区域边栏选项卡中，在 **“设置”** 部分，单击 **“概述”**

1. 验证 **az104-04-vm0** 和 **az104-04-vm1** 的DNS 记录是否出现在记录集列表中，并且其设置为 **“自动注册”**。

    >**注意：**你可能需要等待一分钟，如记录设置未被列出，请再次刷新页面。

1. 把远程桌面会话切换到 **az104-04-vm0**，右键单击 **“开始”** 按钮，然后在右键菜单中单击 **Windows PowerShell (Admin)**。

1. 在“Windows PowerShell”控制台窗口中，运行以下命令以测试在新建专用 DNS 区域中的 **az104-04-vm1** DNS 记录集的内部名称解析：

   ```pwsh
   nslookup az104-04-vm1.contoso.org
   ```
1. 验证命令的输出是否包含 **az104-04-vm1**  的专用 IP 地址 **(10.40.1.4)**。

#### 任务 6：配置 Azure DNS 以进行外部名称解析

在此任务中，你将使用 Azure 公共 DNS 区域配置外部 DNS 名称解析。

1. 在 Azure 门户中，搜索并选择 **“DNS 区域”**，并且在 **“DNS 区域”** 边栏选项卡中单击 **“+ 添加”**。

1. 创建一个 DNS 区域，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | **az104-04-rg1** |
    | 名称 | **contoso.org** |

    >**说明**：等待创建 DNS 区域。该操作需约 2 分钟。 

1. 点击 **“前往资源”**，以打开 **contoso.org** “DNS 区域”边栏选项卡。 

1. 在 **contoso.org** “DNS 区域”边栏选项卡中，单击 **“+ 记录集”**。

1. 添加一个记录集，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-04-vm0** |
    | 类型 | **A** |
    | 别名记录集 | **否** |
    | TTL | **1** |
    | TTL 单位 | **小时** |
    | IP 地址 | 你在本实验室的第三个练习中确定的公用 IP 地址 **az104-04-vm0**  |

1. 添加一个记录集，设置如下（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | --- |
    | 名称 | **az104-04-vm1** |
    | 类型 | **A** |
    | 别名记录集 | **否** |
    | TTL | **1** |
    | TTL 单位 | **小时** |
    | IP 地址 | 你在本实验室的第三个练习中确定的 **az104-04-vm1** 的公共 IP 地址  |

1. 在 **“contoso.org”** DNS 区域边栏选项卡中，注意名为 **“Name server 1”**的条目。

1. 在 Azure 门户中，通过单击 Azure 门户右上方的图标打开 **“Cloud Shell”** 中的 **“PowerShell”** 会话。

1. 在 Cloud Shell 窗格中，运行以下命令以测试新创建的 DNS 区域中设置的 **az104-04-vm0** DNS 记录的外部名称解析（将占位符 `[Name server 1]` 替换为你之前在本任务中记录的 **Name server 1** 名称）：

   ```pwsh
   nslookup az104-04-vm0.contoso.org [Name server 1]
   ```
1. 验证命令输出是否包含公共 IP 地址 **az104-04-vm0**。

1. 在“Cloud Shell”窗格中，运行以下命令以在新建的 DNS 区域中测试 **az104-04-vm1** DNS 记录集的外部名称解析（将占位符 `[Name server 1]` 替换为你之前在任务中记录的 **Name server 1** 名称）：

   ```pwsh
   nslookup az104-04-vm1.contoso.org [Name server 1]
   ```
1. 验证命令的输出是否包含 **az104-04-vm1** 的公共 IP 地址。

#### 清理资源

   >**说明**：记得移除任何你不再使用的新创建的 Azure 资源。移除未使用的资源，确保不产生意外费用。

1. 在 Azure 门户中，打开 **“Cloud Shell”** 窗格中的 **“PowerShell”** 会话。

1. 通过运行以下命令，列出在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-04*'
   ```

1. 通过运行以下命令，删除在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-04*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令异步执行（由 -AsJob 参数确定），因此尽管此后你可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能移除资源组。

#### 回顾

在本实验室中，你已：

- 创建和配置虚拟网络
- 将虚拟机部署到虚拟网络中
- 配置 Azure VM 的专用和公共 IP 地址
- 配置网络安全组
- 配置 Azure DNS 以进行内部名称解析
- 配置 Azure DNS 以进行外部名称解析
