---
lab:
    title: '08 - 管理虚拟机'
    module: '模块 08 - 虚拟机'
---

# 实验室 08 - 管理虚拟机
# 学生实验室手册

## 实验室场景

你的任务是确定用于部署和配置 Azure 虚拟机的不同选项。首先，你需要确定在使用 Azure 虚拟机时可以实现的不同计算和存储弹性以及可缩放选项。接下来，你需要研究使用 Azure 虚拟机规模集时可用的计算和存储弹性以及可缩放选项。你还希望探索通过使用 Azure 虚拟机自定义脚本扩展自动配置虚拟机和虚拟机规模集的功能。

## 目标

在本实验室中，你将：

+ 任务 1：使用 Azure 门户和 Azure 资源管理器模板部署具有区域弹性的 Azure 虚拟机
+ 任务 2：使用虚拟机扩展配置 Azure 虚拟机
+ 任务 3：缩放 Azure 虚拟机的计算和存储
+ 任务 4：使用 Azure 门户部署具有区域弹性的 Azure 虚拟机规模集
+ 任务 5：使用虚拟机扩展配置 Azure 虚拟机规模集
+ 任务 6：缩放 Azure 虚拟机规模集的计算和存储（可选）

## 说明

### 练习 1：

#### 任务 1：使用 Azure 门户和 Azure 资源管理器模板部署具有区域弹性的 Azure 虚拟机

在此任务中，你将使用 Azure 门户和 Azure 资源管理器模板将 Azure 虚拟机部署到不同的可用性区域。

1. 登录至 [Azure 门户](http://portal.azure.com)。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡上，单击 **“+ 添加”**。

1. 在“创建虚拟机”边栏选项卡的 **“基本”** 选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 订阅 | 你将在本实验室中使用的 Azure 订阅名 |
    | 资源组 | 新资源组名称 **az104-08-rg01** |
    | 虚拟机名称 | **az104-08-vm0** |
    | 区域 | 选择一个支持可用性区域并可在其中预配 Azure 虚拟机的区域 | 
    | 可用性选项 | **可用性区域** |
    | 可用性区域 | **1** |
    | 图像 | **Windows Server 2019 Datacenter** |
    | Azure Spot 实例 | **否** |
    | 大小 | **标准 D2s v3** |
    | 用户名 | **Student** |
    | 密码 | **Pa55w.rd1234** |
    | 公共入站端口 | **无** |
    | 已有 Windows Server 许可 | **否** |

1. 单击 **“下一步：磁盘 >”**，然后在 **“创建虚拟机”** 边栏选项卡的 **“磁盘”** 选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 操作系统磁盘类型 | **标准 HDD** |
    | 启用超强磁盘兼容性 | **否** |

1. 单击 **“下一步： 网络 >”**，在 **“创建虚拟机”** 边栏选项卡上的 **“网络”** 选项卡上，单击 **“虚拟网络”** 文本框下的 **“新建”**。

1. 在 **“创建虚拟网络”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 名称 | **az104-08-rg01-vnet** |
    | 地址范围 | **10.80.0.0/20** |
    | 子网名 | **subnet0** |
    | 子网范围 | **10.80.0.0/24** |
 
1. 点击 **“确定”**，然后返回到 **“创建虚拟机”** 边栏选项卡的 **“网络”** 选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 公共 IP | **无** |
    | NIC 网络安全组 | **无** |
    | 加速网络 | **关闭** |
    | 是否将此虚拟机置于现有负载均衡解决方案之后？ | **否** |

1. 单击 **“下一步： 管理 >”**，然后在 **“创建虚拟机”** 边栏选项卡的 **“管理”** 选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 免费启用基本计划 | **否** |
    | 启动诊断 | **关闭** |

1. 单击 **“下一步： 高级 >”**，在 **“创建虚拟机”** 边栏选项卡上的 **“管理”** 选项卡中，查看可用设置，不要对设置做任何修改，然后单击 **“查看 + 创建”**。

1. 在 **“查看 + 创建”** 边栏选项卡上，单击 **“创建”** 。

1. 在 **“部署”** 边栏选项卡上，单击 **“模板”** 。

1. 查看表示正在进行部署的模板，然后单击 **“部署”** 。

    >**说明**：你将使用此选项来部署具有匹配配置的第二个虚拟机（可用性区域除外）。 

1. 在 **“自定义部署”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 资源组 | **az104-08-rg01** |
    | 网络接口名称 | **az104-08-vm1-nic1** |
    | 虚拟机名称 | **az104-08-vm1** |
    | 管理员用户名 | **Student** |
    | 管理员密码 | **Pa55w.rd1234** |
    | 区域 | **2** |

    >**说明**：你需要使用模板来修改与要部署的不同资源的属性相对应的参数（包括虚拟机及其网络接口）。如果希望部署包含两台区域冗余型虚拟机，你还需要指定不同的可用性区域。

1. 选中 **“我同意上述条款和条件”** 旁边的复选框，然后单击 **“购买”**。

    >**说明**：等待两个部署完成，然后继续进行下一个任务。该操作需要约 5 分钟。

#### 任务 2：使用虚拟机扩展配置 Azure 虚拟机

在此任务中，你将使用自定义脚本虚拟机扩展在上一个任务中部署的两个 Azure 虚拟机上安装Windows Server Web 服务器角色。 

1. 在 Azure 门户中，搜索并选择 **“虚拟机”** ，然后在 **“虚拟机”** 边栏选项卡上，单击 **az104-08-vm0**。

1. 在 **“az104-08-vm0”** 虚拟机边栏选项卡上的 **“设置”** 部分，单击 **“扩展”** ，然后再单击 **“+ 添加”**。

1. 在 **“新建资源”** 边栏选项卡上，单击 **“自定义脚本扩展”**，然后再单击 **“创建”**。

1. 在 **“安装扩展”** 边栏选项卡上，上传 **\\Allfiles\\Labs\\08** 中的脚本 **az104-08-install_IIS.ps1**，然后单击 **“确定”**。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡上，单击 **az104-08-vm1**。

1. 在 **az104-08-vm1** 边栏选项卡的 **“设置”** 部分，单击 **“导出模板”**。

1. 在 **“az104-08-vm1 - 导出模板”** 边栏选项卡上，单击 **“部署”**。 

1. 在 **“自定义部署”** 边栏选项卡上，单击 **“编辑模板”**。

1. 在 **“编辑模板”** 边栏选项卡上，在显示模板内容的部分中，插入以下以行 **20** 开头的代码（直接插入以下代码下方：`    "resources": [` line):

   ```json
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "az104-08-vm1/customScriptExtension",
            "apiVersion": "2018-06-01",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "az104-08-vm1"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.7",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "commandToExecute": "powershell.exe Install-WindowsFeature -name Web-Server -IncludeManagementTools && powershell.exe remove-item 'C:\\inetpub\\wwwroot\\iisstart.htm' && powershell.exe Add-Content -Path 'C:\\inetpub\\wwwroot\\iisstart.htm' -Value $('Hello World from ' + $env:computername)"
              }
            }
        },   

   ```

    >**注意**：模板的此部分定义了与你先前通过 Azure PowerShell 部署到第一台虚拟机相同的 Azure 虚拟机自定义脚本扩展。

1. 单击 **“保存”**，然后返回到 **“自定义模板”** 边栏选项卡，启用复选框 **“我同意上述条款和条件”**，然后单击 **“购买”** 。

    >**说明**：忽略消息 - **资源组位于模板中一个或多个资源不支持的位置。请选择其他资源组**。这是预期的，在这种情况下可以忽略。

    >**说明**：等待模板部署完成。可以从 **az104-08-vm0** 和 **az104-08-vm1** 虚拟机的 **“扩展”** 边栏选项卡监视其进度。这应该不超过 3 分钟。

1. 要验证基于自定义脚本扩展的配置是否成功，请导航回 **“az104-08-vm1”** 边栏选项卡，在 **“操作”** 部分，单击 **“运行命令”**，然后在命令列表中，单击 **“RunPowerShellScript”**。

1. 在 **“运行命令脚本”** 边栏选项卡上，键入以下命令并单击 **“运行”**，访问 **az104-08-vm0** 上托管的网站：

   ```pwsh
   Invoke-WebRequest -URI http://10.80.0.4 -UseBasicParsing
   ```

    >**备注**：必须使用 **-UseBasicParsing** 参数才能消除对 Internet Explorer 的依赖性，以完成 cmdlet 的执行

    >**说明**：还可以连接到 **az104-08-vm0** 并运行 `Invoke-WebRequest -URI http://10.80.0.5` 以访问 **az104-08-vm1** 上托管的网站。

#### 任务 3：缩放 Azure 虚拟机的计算和存储

在此任务中，你将通过更改 Azure 虚拟机的大小来缩放其计算，并通过附加和配置其数据磁盘来缩放其存储。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡上，单击 **az104-08-vm0**。

1. 在 **az104-08-vm0** 虚拟机边栏选项卡上，单击 **“大小”**，并将虚拟机大小设置为 **“标准 DS1_v2”**

    >**说明**：如果 **“标准 DS1_v2”** 不可用，请选择其他大小。

1. 在 **az104-08-vm0** 虚拟机边栏选项卡上，依次单击 **“磁盘”**、 **“+ 添加数据磁盘”**，然后在 **“名称”** 下拉列表中，单击 **“创建磁盘”**。

1. 使用以下设置创建托管磁盘（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 磁盘名称 | **az104-08-vm0-datadisk-0** |
    | 源类型 | **无** |
    | 帐户类型 | **高级 SSD** |
    | 大小 | **1024 GiB** |


1. 回到 **“az104-08-vm0 - 磁盘”** 边栏选项卡，单击 **“+ 添加数据磁盘”**，然后在 **“名称”** 下拉列表中，单击 **“创建磁盘”**。

1. 使用以下设置创建托管磁盘（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 磁盘名称 | **az104-08-vm0-datadisk-1** |
    | 源类型 | **无** |
    | 帐户类型 | **高级 SSD** |
    | 大小 | **1024 GiB** |

1. 回到 **“az104-08-vm0 - 磁盘”** 边栏选项卡，单击 **“保存”**。

1. 在 **az104-08-vm0** 边栏选项卡上，在 **“操作”** 部分中，单击 **“运行命令”**，然后在命令列表中单击 **RunPowerShellScript**。

1. 在 **“运行命令脚本”** 边栏选项卡上，键入以下命令，然后单击 **“运行”**，以创建一个由两个新连接磁盘组成的驱动器 Z:，它具有简单的布局和固定的设置：

   ```pwsh
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```

    > **注意**：等待确认命令已成功完成。

1. 在 Azure 门户中，搜索并选择 **“虚拟机”**，然后在 **“虚拟机”** 边栏选项卡上，单击 **az104-08-vm1**。

1. 在 **az104-08-vm1** 边栏选项卡的 **“设置”** 部分，单击 **“导出模板”**。

1. 在 **“az104-08-vm1 - 导出模板”** 边栏选项卡上，单击 **“部署”**。 

1. 在 **“自定义部署”** 边栏选项卡上，单击 **“编辑模板”**。

1. 在 **“编辑模板”** 边栏选项卡上，在显示模板内容的部分中，替换第 **30** 行 `                    "vmSize": "Standard_D2s_v3"` 替换为以下行）：

   ```json
                    "vmSize": "Standard_DS1_v2"

   ```

    >**注意**：模板的此部分定义了一台虚拟机，其大小与你通过 Azure 门户指定的第一台虚拟机相同。


1. 在 **“编辑模板”** 边栏选项卡上，在显示模板内容的部分中，将 **49** 行 (`                    "dataDisks": [ ]` line) 替换为以下代码：

   ```json
                    "dataDisks": [
                      {
                        "lun": 0,
                        "name": "az104-08-vm1-datadisk0",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      },
                      {
                        "lun": 1,
                        "name": "az104-08-vm1-datadisk1",
                        "diskSizeGB": "1024",
                        "caching": "ReadOnly",
                        "createOption": "Empty"
                      }
                    ]
   ```

    >**备注**：模板的此部分创建两个托管磁盘并将它们连接到 **az104-08-vm1**，类似于通过 Azure 门户的第一个虚拟机的存储配置。

1. 单击 **“保存”**，然后返回到 **“自定义模板”** 边栏选项卡，启用复选框 **“我同意上述条款和条件”** ，然后单击 **“购买”**。

    >**说明**：忽略消息 - **资源组位于模板中一个或多个资源不支持的位置。请选择其他资源组**。这是预期的，在这种情况下可以忽略。

    >**说明**：等待模板部署完成。你可以从 **az104-08-vm1** 虚拟机的 **“扩展”** 边栏选项卡监视其进度。这应该不超过 3 分钟。

1. 回到 **az104-08-vm1** 边栏选项卡，在 **“操作”** 部分中，单击 **“运行命令”**，然后在命令列表中单击 **RunPowerShellScript**。

1. 在 **“运行命令脚本”** 边栏选项卡上，键入以下命令，然后单击 **“运行”**，以创建一个由两个新连接磁盘组成的驱动器 Z:，它具有简单的布局和固定的设置：

   ```pwsh
   New-StoragePool -FriendlyName storagepool1 -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks (Get-PhysicalDisk -CanPool $true)

   New-VirtualDisk -StoragePoolFriendlyName storagepool1 -FriendlyName virtualdisk1 -Size 2046GB -ResiliencySettingName Simple -ProvisioningType Fixed

   Initialize-Disk -VirtualDisk (Get-VirtualDisk -FriendlyName virtualdisk1)

   New-Partition -DiskNumber 4 -UseMaximumSize -DriveLetter Z
   ```
    > **注意**：等待确认命令已成功完成。

#### 任务 4：使用 Azure 门户部署具有区域弹性的 Azure 虚拟机规模集

在此任务中，你将使用 Azure 门户跨可用性区域部署 Azure 虚拟机规模集。

1. 在 Azure 门户中，搜索并选择 **“虚拟机规模集”**，然后在 **“虚拟机规模集”** 边栏选项卡上，单击 **“+ 添加”**。

1. 在 **“创建虚拟机规模集”** 边栏选项卡的 **“基础”** 选项卡上，指定以下设置（将其他设置保留为默认值），然后单击 **“下一步： 磁盘 >”**：

    | 设置 | 数值 | 
    | --- | --- |
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |    
    | 资源组 | 新资源组的名称 **“az104-08-rg02”** |    
    | 虚拟机规模集名称 | **az10408vmss0** |
    | 区域 | 选择一个支持可用性区域的区域，你可以在其中预配与本实验室之前所部署虚拟机不同的 Azure 虚拟机 | 
    | 可用性区域 | **区域 1、2、3** |
    | 图像 | **Windows Server 2016 Datacenter** |
    | Azure Spot 实例 | **否** |
    | 大小 | **标准 D2s_v3** |    
    | 用户名 | **Student** |
    | 密码 | **Pa55w.rd1234** |
    | 是否已拥有 Windows Server 许可？ | **否** |

    >**说明**：有关支持将 Windows 虚拟机部署到可用性区域的 Azure 区域列表，请参阅 [Azure 中的可用性区域是什么？](https://docs.microsoft.com/zh-cn/azure/availability-zones/az-overview)

1. 在 **“创建虚拟机规模集”** 边栏选项卡的 **“磁盘”** 选项卡上，接受默认值并单击 **“下一步： 网络 >”**。

1. 在 **“创建虚拟机规模集”** 边栏选项卡的 **“网络”** 选项卡上，单击 **“虚拟网络”** 文本框下方的 **“创建虚拟网络”** 链接，并使用以下设置新建虚拟网络（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 名称 | **az104-08-rg02-vnet** |
    | 地址范围 | **10.82.0.0/20** |
    | 子网名 | **subnet0** |
    | 子网范围 | **10.82.0.0/24** |
 
    >**说明**：创建新的虚拟网络并返回到 **“创建虚拟机规模集”** 边栏选项卡的 **“网络”** 选项卡后， **“虚拟网络”** 值将自动设置为 **az104-08-rg02-vnet**。

1. 回到 **“创建虚拟机规模集”** 边栏选项卡的 **“网络”** 选项卡上，单击网络接口项右侧的 **“编辑网络接口”** 图标。 

1. 在 **“编辑网络结构”** 边栏选项卡上的 **“NIC 网络安全组”** 部分中，单击 **“高级”**，然后单击 **“配置网络安全组”** 下拉列表下的 **“新建”**。

1. 在 **“创建网络安全组”** 边栏选项卡上，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 名称 | **az10408vmss0-nsg** |

1. 单击 **“添加入站规则”** 并使用以下设置添加入站安全规则（将其他设置保留为默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | 源 | **任何** |
    | 源端口范围 | **\*** |
    | 目标 | **任何** |
    | 目标端口范围 | **80** |
    | 协议 | **TCP** |
    | 操作 | **允许** |
    | 优先级 | **1010** | 
    | 名称 | **custom-allow-http** |

1. 单击 **“添加”**，然后回到 **“创建网络安全组”** 边栏选项卡，单击 **“确定”**。

1. 回到 **“编辑网络接口”** 边栏选项卡，在 **“公用 IP 地址”** 部分，单击 **“已启用”**，然后再单击 **“确定”**。

1. 回到 **“创建虚拟机规模集”** 边栏选项卡的 **“网络”** 标签页 ，指定以下设置（将其他设置保留为默认值），然后单击 **“下一步： 缩放>”**:

    | 使用一个负载均衡器 | **是** |
    | 负载均衡选项 | **Azure 负载均衡器** |
    | 选择一个负载均衡器 | **（新）az10408vmss0-lb** |
    | 选择一个“后端池” | **（新）bepool** |
    
1. 在  **“创建虚拟机规模集”** 边栏选项卡的 **“缩放”** 的标签页上，指定以下设置（将其他设置保留为默认值），然后点击 **“下一步： 管理>”**。

    | 设置 | 数值 | 
    | --- | --- |
    | 初始实例计数 | **2** |
    | 缩放策略 | **手动** |

1. 在  **“创建虚拟机规模集”** 边栏选项卡的 **“管理”** 的标签页上，指定以下设置（将其他设置保留为默认值），然后单击 **“下一步： 运行状况 >”**：

    | 设置 | 数值 | 
    | --- | --- |
    | 启动诊断 | **关闭** |
    
1. 在 **“创建虚拟机规模集”** 边栏选项卡的 **“运行状况”** 标签页上，查看默认设置而不做任何更改，然后单击 **“下一步： 高级 >”**。

1. 在 **“创建虚拟机规模集”** 边栏选项卡上的 **“高级”** 标签页上，指定以下设置（保留其他默认设置），然后单击 **“查看 + 创建”**。

    | 设置 | 数值 | 
    | --- | --- |
    | 分摊算法 | **最大分摊** |

1. 在 **“创建虚拟机规模集”** 边栏选项卡的 **“查看+创建”** 的标签页上，确保已通过验证，然后单击 **“创建”**。

    >**说明**：等待“虚拟机规模集部署”完成。该操作大需要约 5 分钟。


#### 任务 5：使用虚拟机扩展配置 Azure 虚拟机规模集

在此任务中，你将通过使用自定义脚本虚拟机扩展将 Windows Server Web 服务器角色安装在上一个任务中部署的 Azure 虚拟机规模集的实例上。 

1. 在 Azure 门户中，刷新 **“虚拟机规模集”** 边栏选项卡，单击 **“az10408vmss0”**。

1. 在 **“az10408vmss0”** 边栏选项卡上，单击 **“扩展”**，然后再单击 **“+ 添加”**。

1. 在 **“新建资源”** 边栏选项卡上，单击 **“自定义脚本扩展”**，然后再单击 **“创建”**。

1. 在 **“安装扩展”** 边栏选项卡上，上传 **\\Allfiles\\Labs\\08** 中的脚本 **az104-08-install_IIS.ps1**，然后单击 **“确定”**。

    >**说明**：请等待扩展安装完成后再继续下一步。

1. 在 **“az10408vmss0”** 边栏选项卡的 **“设置”** 部分，单击 **“实例”**，并选中虚拟机规模集的两个实例旁边的复选框，然后单击 **“升级”**，最后在提示确认时单击 **“是”**。

    >**说明**：请等待升级完成后再继续下一步。

1. 在 Azure 门户中，搜索并选择 **“负载均衡器”**，然后在负载均衡器列表中单击 **“az10408vmss0lb”**。

1. 在 **“az10408vmss0lb”** 边栏选项卡中，查看并记下分配到负载均衡器前端的 **“公用 IP 地址”** 值，打开一个新的浏览器标签页，然后导航到该 IP 地址。

    >**说明**：验证浏览器页面是否显示 Azure 虚拟机规模集 **“az10408vmss0”** 其中一个实例的名称。


#### 任务 6：缩放 Azure 虚拟机规模集的计算和存储

在此任务中，你需要更改虚拟机规模集实例的大小，配置其“自动缩放”设置，并向这些示例附加磁盘。

1. 在 Azure 门户中，在 **“az10408vmss0”** 边栏选项卡上，单击 **“大小”**。

1. 在可用大小列表中，选择 **“标准 DS1_v2”**，然后单击 **“调整大小”**。

1. 在 **“设置”** 部分，单击 **“实例”**，选中虚拟机规模集两个实例旁边的复选框，然后单击 **“升级”**，然后在提示你确认时单击 **“是”**。

1. 在实例列表中，单击代表第一个实例的条目，然后在“规模集实例”边栏选项卡上记下其 **“位置”** （它应该是目标 Azure 区域中部署 Azure 虚拟机规模集的区域之一。） 

1. 返回到 **“az10408vmss0 - 实例”** 边栏选项卡上，单击代表第二个实例的条目，然后在“规模集实例”边栏选项卡上，记下其 **“位置”** （它应该是目标 Azure 区域中部署 Azure 虚拟机规模集的其他两个区域之一）。 

1. 返回到 **“az10408vmss0 - 实例”** 边栏选项卡，并单击 **“缩放”**。

1. 在 **“az10408vmss0 - 缩放”** 边栏选项卡上，选择 **“自定义自动缩放”** 选项，并使用以下设置来配置自动缩放（将其他设置保留为默认值）：

    | 设置 | 数值 |
    | --- |--- |
    | 缩放模式 | **根据指标进行缩放** | 

1. 单击 **“+ 添加规则”** 链接，并在 **“缩放规则”** 边栏选项卡上指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 |
    | --- |--- |
    | 度量值源 | **当前资源 (az10480vmss0)** |
    | 时间聚合 | **最大** |
    | 指标命名空间 | **虚拟机主机** |
    | 指标名称 | **总网络流入量** |
    | 运算符 | **大于** |
    | 触发缩放操作的指标阈值 | **10** |
    | 持续时间（以分钟为单位） | **1** |
    | 时间粒度统计 | **最大** |
    | 操作 | **增加计数** |
    | 实例计数 | **1** |
    | 冷却（分钟） | **5** |

    >**说明**：显然，这些值并不代表实际配置，因为它们的目的是在不延长等待时间的情况下尽快触发自动缩放。 

1. 单击 **“添加”** ，回到 **“az10408vmss0 - 缩放”** 边栏选项卡，指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 |
    | --- |--- |
    | 实例限制（最小值） | **1** |
    | 实例限制（最大值） | **3** |
    | 实例限制（默认） | **1** |

1. 单击 **“保存”**。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

    >**说明**：如果这是你第一次启动 **“Cloud Shell”**，并看到 **“你没有装载存储”** 的消息，请选择你在本实验中使用的订阅，然后单击 **“创建存储”**。 

1. 在“Cloud Shell”窗格中，运行以下命令以识别 Azure 虚拟机规模集 **“az10408vmss0”** 前面的负载均衡器的公用 IP 地址。

   ```pwsh
   $rgName = 'az104-08-rg02'

   $lbpipName = 'az10408vmss0-ip'

   $pip = (Get-AzPublicIpAddress -ResourceGroupName $rgName -Name $lbpipName).IpAddress
   ```
1. 在 Cloud Shell 窗格中，运行以下命令以启动无限循环，该循环将 HTTP 请求发送到 Azure 虚拟机规模集 **“az10408vmss0”** 的实例托管的网站上。

   ```pwsh
   while ($true) { Invoke-WebRequest -Uri "http://$pip" }
   ```

1. 最小化“Cloud Shell”窗格，但不要关闭，切换到 **“az10408vmss0 - 实例”** 边栏选项卡并监视实例数。

    >**说明**：你可能需要等待几分钟，然后单击 **“刷新”** 。

1. 第三个实例预配好后，导航至其边栏选项卡以确定其 **“位置”** （它应该与你在此任务前面确定的前两个区域不同）。 

1. 关闭 Cloud Shell 窗格。 

1. 在 **“az10408vmss0”** 边栏选项卡上，单击 **“存储”**，再单击 **“+ 添加数据磁盘”**，并使用以下设置附加新的托管磁盘（保留其他设置的默认值）：

    | 设置 | 数值 | 
    | --- | --- |
    | LUN | **0** |
    | 大小 | **32** |
    | 帐户类型 | **标准 HDD** |
    | 主机缓存 | **无** |

1. 保存更改，在 **“az10408vmss0”** 边栏选项卡上的 **“设置”** 部分单击 **“实例”**，选择两个虚拟机规模集实例旁边的复选框，然后单击 **“升级”**，最后在提示确认时单击 **“是”**。

    >**说明**：上一步附加的磁盘是原始磁盘。在使用它之前，你需要创建一个分区，创建一个文件系统并对其进行装载。为此，你需要使用 Azure 虚拟机自定义脚本扩展。首先，你需要删除现有的自定义脚本扩展。

1. 在 **“az10408vmss0”** 边栏选项卡的 **“设置”** 部分单击 **“扩展”**，然后单击 **“CustomScriptExtension”**，最后单击 **“卸载”**。

    >**说明**：等待卸载完成。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

1. 在 Cloud Shell 窗格的工具栏中，单击 **“上传/下载文件”** 图标；在下拉菜单中单击 **“上传”** 并上传文件 **“\\Allfiles\\Labs\\08\\az104-08-configure_VMSS_disks.ps1”** 到 Cloud Shel 主目录中。

1. 在 Cloud Shell 窗格中，运行下列命令以显示脚本内容：

   ```pwsh
   Set-Location -Path $HOME

   Get-Content -Path ./az104-08-configure_VMSS_disks.ps1
   ```

    >**备注**：该脚本将安装一个自定义脚本扩展，用于配置附加的磁盘。

1. 在“Cloud Shell”窗格中运行以下命令以执行脚本并配置 Azure 虚拟机规模集的磁盘：

   ```pwsh
   ./az104-08-configure_VMSS_disks.ps1
   ```

1. 关闭 Cloud Shell 窗格。

1. 在 **“az10408vmss0”** 边栏选项卡的 **“设定”** 部分，单击 **“实例”**，并选中虚拟机规模集的两个实例旁边的复选框，然后单击 **“升级”**，最后在提示确认时单击 **“是”**。

#### 清理资源

   >**说明**：记得移除任何你不再使用的新创建的 Azure 资源。移除未使用的资源，确保不产生意外费用。

1. 在 Azure 门户中，打开 **“Cloud Shell”** 窗格中的 **“PowerShell”** 会话。

1. 通过运行以下命令，列出在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-08*'
   ```

1. 通过运行以下命令，删除在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-08*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令异步执行（由 -AsJob 参数确定），因此尽管此后你可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能移除资源组。

#### 回顾

在本实验室中，你已：

- 使用 Azure 门户和 Azure 资源管理器模板部署具有区域弹性的 Azure 虚拟机
- 使用虚拟机扩展来配置 Azure 虚拟机
- 缩放 Azure 虚拟机的计算和存储
- 使用 Azure 门户部署具有区域弹性的 Azure 虚拟机规模集
- 使用虚拟机扩展配置 Azure 虚拟机规模集
- 缩放 Azure 虚拟机规模集的计算和存储
