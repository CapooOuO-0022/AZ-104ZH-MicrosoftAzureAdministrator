---
lab:
    title: '09a - 实现 Web 应用'
    module: '模块 09 - 无服务器计算'
---

# 实验室 09a - 实现 Web 应用
# 学生实验室手册

## 实验室场景

你需要评估使用 Azure Web 应用托管 Contoso 网站的情况，该网站当前托管在公司的本地数据中心中。这些网站运行于使用 PHP 运行时堆栈的 Windows 服务器上。你还需要确定如何利用 Azure Web 应用部署槽位来进行 DevOps 实践。

## 目标

在本实验室中，你将：
  
+ 任务 1：创建 Azure Web 应用
+ 任务 2：创建暂存部署槽位
+ 任务 3：配置 Web 应用部署设置
+ 任务 4：将代码部署到暂存部署槽位
+ 任务 5：交换暂存槽位
+ 任务 6：配置并测试 Azure Web 应用的自动缩放
  
## 预计用时：30 分钟
  
## 说明

### 练习 1：

#### 任务 1：创建 Azure Web 应用

在此任务中，你将创建一个 Azure Web 应用。 

1. 登录至 [**Azure 门户**](http://portal.azure.com)。

1. 在 Azure 门户中，搜索并选 **“应用服务”**，以及在 **“应用服务”** 边栏选项卡中，单击 **“+ 添加”**。

1. 在 **“Web 应用”** 边栏选项卡的 **“基本”** 选项卡中，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- | ---|
    | 订阅 | 你在本实验室中使用的 Azure 订阅的名称 |
    | 资源组 | 一个新资源组的名称 **az104-09a-rg1** |
    | Web 应用名称 | 任何全局唯一名称 |
    | 发布 | **代码** |
    | 运行时堆栈 | **PHP 7.3** |
    | 操作系统 | **Windows** |
    | 区域 | 你可以在其中预配 Azure Web 应用的 Azure 区域的名称 |
    | 应用服务计划 | 接受默认配置 |

1. 单击 **“下一步: 监视 >”** ，在 **“Web 应用”** 边栏选项卡的 **“监视”** 选项卡上，把 **“启用应用程序见解”** 切换到 **“否”**，单击 **“查看 + 创建”**，然后单击 **“创建”**。 

    >**说明**：通常，你需要启用 **“Application Insights”**，但是，本实验室没有使用该功能。

    >**说明**：等到 Web 应用创建完成，再继续执行下一个任务。该操作需要约一分钟。 

1. 在“部署”边栏选项卡中，单击 **“前往资源”**。

#### 任务 2：创建暂存部署槽位

在此任务中，你将创建一个暂存部署槽位。 

1. 在新部署的 Web 应用的边栏选项卡中，点击 **“URL”** 链接，以便在新的浏览器选项卡中显示默认网页。

1. 关闭新的浏览器选项卡，然后返回 Azure 门户中的“Web 应用”边栏选项卡的 **“部署”** 部分，单击 **“部署槽位”**。 

    >**说明**：此时，该 Web 应用具有一个单独的标记为 **“PRODUCTION”** 的部署槽位。 

1. 请点击 **“+ 添加槽位”**，并添加新槽位，设置如下： 

    | 设置 | 数值 |
    | --- | ---|
    | 名称 | **暂存** |
    | 克隆设置位置 | **请勿克隆设置** |

1. 返回到“Web 应用”的 **“部署槽位”** 边栏选项卡，单击表示新建暂存槽位的条目。 

    >**说明**：这将打开显示暂存槽位属性的边栏选项卡。 

1. 查看“暂存槽位”边栏选项卡，并注意其 URL 与分配到生产槽的 URL 不同。

#### 任务 3：配置 Web 应用部署设置

在此任务中，你将配置 Web 应用部署设置。 

1. 在“暂存部署槽位”边栏选项卡上，在 **“部署”** 部分，单击 **“部署中心”**。

    >**注意**：确保你位于“暂存槽位”边栏选项卡（而不是生产槽位）。

1. 在 **“持续部署 (CI/CD)”** 部分，选择 **“本地 Git”**，然后单击 **“继续”**。

1. 选择 **“应用服务生成服务”**，单击 **“继续”**，然后单击 **“完成”**。 

1. 将生成的 **“Git 克隆 URL”** 复制到记事本。

    >**注意**：本实验的下一个任务将需要  Git 克隆 URL 的值。

1. 点击 **“部署凭据”** 工具栏图标，以显示 **“部署凭据”** 窗格。 

1. 单击 **“用户凭据”**。

1. 完成所需的信息，然后单击 **“保存凭据”**。 

    | 设置 | 数值 |
    | --- | ---|
    | 用户名 | 任何唯一的名称 |
    | 密码 | **Pa55w0rd1234** |

    >**注意**：本实验的下一个任务将需要这些凭据。

#### 任务 4：将代码部署到暂存部署槽位

在此任务中，你会将代码部署到暂存部署槽位。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

    >**说明**：如果这是你第一次启动 **“Cloud Shell”**，并看到 **“你没有装载存储”** 的消息，请选择你在本实验中使用的订阅，然后单击 **“创建存储”**。 

1. 在“Cloud Shell”窗格中，运行以下命令以克隆包含 Web 应用代码的远程存储库。

   ```pwsh
   git clone https://github.com/Azure-Samples/php-docs-hello-world
   ```
 
1. 在“Cloud Shell”窗格中，运行以下命令将当前位置设置为新创建的包含示例 Web 应用代码的本地存储库的克隆。

   ```
   Set-Location -Path $HOME/php-docs-hello-world/
   ```

1. 在“Cloud Shell”窗格中，运行以下命令以添加远程 git（请确保将 `[deployment_user_name]` 和 `[git_clone_url]` 占位符分别替换为你在上一个任务中确定的 **“部署凭据”** 用户名和 **“Git 克隆 URL”** 的值）：

   ```
   git remote add [deployment_user_name] [git_clone_url]
   ```

    >**注意**：`git remote add` 之后的值不需要与 **“部署凭据”** 用户名相匹配，但必须唯一

1. 在“Cloud Shell”窗格中，运行以下命令将示例 Web 应用代码从本地的存储库推送到 Azure Web 应用暂存部署槽位（确保将 `[deployment_user_name]` 占位符替换为你在上一个任务中标识的 **“部署凭据”** 用户名的值）：
   ```
   git push [deployment_user_name] master
   ```

1. 如果提示进行身份验证，输入 `[deployment_user_name]` 和相应的密码 (**Pa55w0rd1234**)。

1. 关闭 Cloud Shell 窗格。

1. 在“过渡槽”边栏选项卡中，单击 **“概述”**，然后单击 **“URL”** 链接，以便在新的浏览器选项卡中显示默认网页。

1. 验证浏览器页面显示**Hello World!** 消息并关闭新选项卡。

#### 任务 5：交换暂存槽位

在此任务中，你会将暂存槽位与生产槽位进行交换

1. 导航回到显示 Web 应用生产槽位的边栏选项卡。

1. 在 **“部署”** 部分，单击 **“部署槽位”** ，然后单击 **“交换”** 工具栏图标。

1. 在 **“交换”** 边栏选项卡中，查看默认设置，然后单击 **“交换”**： 

1. 在 Web 应用“生产槽位”边栏选项卡中单击 **“概述”**，然后单击 **“URL”** 链接以在新的浏览器选项卡中显示网站主页。

1. 验证默认网页是否已替换为 **Hello World!** 页面。 

#### 任务 6：配置并测试 Azure Web 应用的自动缩放

在此任务中，将配置和测试 Azure Web 应用的自动缩放。 

1. 在显示 Web 应用生产槽的边栏选项卡中，在 **“设置”** 部分，单击 **“横向扩展（应用服务计划）”**。

1. 单击 **“自定义自动缩放”**。 

    >**说明**：你还可以选择手动缩放 Web 应用。

1. 保留默认选项 **“根据指标进行缩放”** 的选中状态，并单击 **“+ 添加一个规则”** 

1. 在 **“缩放规则”** 边栏选项卡上，指定以下设置（保留其他设置的默认值）：

    | 设置 | 数值 |
    | --- |--- |
    | 度量值源 | **当前资源** |
    | 时间聚合 | **最大** |
    | 指标命名空间 | **应用服务计划标准指标** |
    | 指标名称 | **CPU 比例** |
    | 运算符 | **大于** |
    | 触发缩放操作的指标阈值 | **10** |
    | 持续时间（以分钟为单位） | **1** |
    | 时间粒度统计 | **最大** |
    | 操作 | **增加计数** |
    | 实例计数 | **1** |
    | 冷却（分钟） | **5** |

    >**说明**：显然，这些值并不代表实际配置，因为它们的目的是在不延长等待时间的情况下尽快触发自动缩放。 

1. 请点击 **“增加”** 然后，回到 **“az10408vmss0-缩放”** 边栏选项卡，请指定以下设置（将其他设置保留为默认值）：

    | 设置 | 数值 |
    | --- |--- |
    | 实例限制（最小值） | **1** |
    | 实例限制（最大值） | **2** |
    | 实例限制（默认） | **1** |

1. 单击 **“保存”** 。

1. 在 Azure 门户中，单击 Azure 门户右上角的图标打开 **“Azure Cloud Shell”**。

1. 如果提示需要选择 **“Bash”** 或 **“PowerShell”**，请选择 **“PowerShell”**。 

1. 在 Cloud Shell 窗格中，运行以下命令以标识 Azure Web 应用的 URL。

   ```pwsh
   $rgName = 'az104-09a-rg1'

   $webapp = Get-AzWebApp -ResourceGroupName $rgName
   ```

1. 在“Cloud Shell”窗格中，运行以下命令启动向 web 应用发送 HTTP请求的无限循环：

   ```pwsh
   while ($true) { Invoke-WebRequest -Uri $webapp.DefaultHostName }
   ```

1. 最小化（但不要关闭）“Cloud Shell”窗格，并在 Web 应用边栏选项卡中的 **“监视”** 部分，单击 **“进程资源管理器”**。

    >**说明**：流程浏览器有助于监视实例数量及其资源利用率。 

1. 监视几分钟的利用率和实例数。

    >**说明**：可能需要**刷新**页面。

1. 一旦注意到实例数已增加到 2，就重新打开 Cloud Shell 窗格格并按 **“Ctrl+C”** 终止脚本。

1. 关闭 Cloud Shell 窗格。

#### 清理资源

   >**说明**：请记得移除任何你不再使用的新创建的 Azure 资源。移除未使用的资源，确保不产生意外费用。

1. 在 Azure 门户中，打开 **“Cloud Shell”** 窗格中的 **“PowerShell”** 会话。

1. 通过运行以下命令，列出在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-09a*'
   ```

1. 通过运行以下命令，删除在本模块实验室中创建的所有资源组：

   ```pwsh
   Get-AzResourceGroup -Name 'az104-09a*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注意**：该命令异步执行（由 -AsJob 参数确定），因此尽管此后你可以立即在同一 PowerShell 会话中运行另一个 PowerShell 命令，但实际上要花几分钟才能移除资源组。

#### 回顾

在本实验室中，你已：

- 创建一个 Azure Web 应用
- 创建一个暂存部署槽位
- 配置 Web 应用部署设置
- 将代码部署到暂存部署槽位
- 交换暂存槽位
- 配置并测试 Azure Web 应用的自动缩放
